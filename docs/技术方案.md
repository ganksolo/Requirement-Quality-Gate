# 技术方案

- ------------------------------------------------------------------------------

项目文档第二部分：技术执行方案与详细架构 (Technical Execution Plan)

**文档性质**：架构设计与实施规范 **目标受众**：架构师、后端工程师、DevOps

**1. 技术架构总览 (Architecture Overview)**

本项目采用 **“三层分离”** 架构，确保业务逻辑（Agent）、流程编排（Graph）与外部交互（Integration）的解耦。

**1.1 系统逻辑分层 (Logical Layers)**

| 层级 | 组件名称 | 技术选型 | 核心职责 |
| --- | --- | --- | --- |
| **L1: 接入层** | **Integration Gateway** | **n8n** (推荐) / Jira Webhook | 监听 Jira 事件，进行格式转换，调用核心服务 API。不含业务逻辑。 |
| **L2: 核心服务层** | **Quality Gate Service** | **FastAPI** + **LangGraph** | 系统的“大脑”。负责 Agent 编排、状态机流转、评分计算。 |
| **L3: 基础设施层** | **Infra Base** | **Postgres** + **LLM Adapter** | 存储评分记录、审计日志；封装 OpenAI/Gemini 调用。 |

**1.2 核心工作流设计 (The DAG)**

我们使用 **LangGraph** 构建一个有向无环图（DAG），确保流程的确定性。

**流程节点流转图：**

```
graph TD
    Start([开始]) --> InputGuard[🛡️ 输入清洗与围栏]
    InputGuard -- 敏感词/过短 --> Reject([🚫 拒绝])
    InputGuard -- 合规 --> Structure[🏗️ Structuring Agent]

    Structure -- 提取失败 --> Score[⚖️ Scoring Agent (Raw Mode)]
    Structure -- 提取成功 --> Score[⚖️ Scoring Agent (Structured Mode)]

    Score --> HardGate{🛑 硬性门禁}

    HardGate -- Score<60 OR Blockers>0 --> OutputFail[📝 生成拒绝报告]
    HardGate -- Score>60 AND No Blockers --> OutputPass[✅ 生成通过凭证]

    OutputFail --> JiraComment[回写 Jira 评论]
    OutputPass --> JiraStatus[流转 Jira 状态]

```

- -------------------------------------------------------------------------------

**2. 微观数据契约 (Micro Data Contracts)**

系统核心采用 **Pydantic** 定义严格的数据契约，这是“Schema-Driven”落地的关键。

**2.1 输入契约 (`TicketInput`)**

用于标准化来自不同渠道（Jira, Slack, 文档）的输入。

```
class TicketInput(BaseModel):
    ticket_id: str
    title: str
    description: str             # 原始需求文本
    source_type: Literal["Jira", "Doc"]
    priority: Literal["P0", "P1", "P2"] = "P1"
    # 用于加载不同的评分规则
    project_key: str             # e.g., "PAY", "OPS"

```

**2.2 输出契约 (`TicketScoreReport`)**

这是评分 Agent 的产出，也是门禁决策的唯一依据。

```
class ReviewIssue(BaseModel):
    # BLOCKER 触发硬拦截，WARNING 仅扣分
    severity: Literal["BLOCKER", "WARNING"]
    # 问题分类：缺失AC、逻辑断点、模糊词汇等
    category: Literal["MISSING_AC", "AMBIGUITY", "LOGIC_GAP", "SECURITY"]
    description: str
    suggestion: str

class TicketScoreReport(BaseModel):
    total_score: int             # 0-100分
    ready_for_review: bool       # Gate 决策结果

    # 维度拆分，便于数据分析
    dimension_scores: dict       # {'completeness': 80, 'clarity': 60}

    blocking_issues: List[ReviewIssue]      # 导致被拒的致命伤
    non_blocking_issues: List[ReviewIssue]  # 优化建议
    summary_markdown: str        # 给 PM 看的最终评语

```

- -------------------------------------------------------------------------------

**3. 核心 Agent 详细设计**

**3.1 PRD Structuring Agent (结构化器)**

- **输入**：杂乱的文本、录音转录。
- **Prompt 策略**：

◦ **角色**：资深产品助理。

◦ **核心指令**：提取 `User Story`, `Acceptance Criteria`, `Dependencies`。

◦ **负向约束**：严禁编造业务逻辑。如果原文没写异常流程，必须在字段中填 `null` 并生成澄清问题，而不是自己瞎编。

- **输出**：`PRD_Draft` JSON 对象。

**3.2 Ticket Scoring Agent (评分器)**

- **输入**：`PRD_Draft` 或 原始文本。
- **Prompt 策略**：

◦ **角色**：严格的 Tech Lead。

◦ **核心指令**：根据 `Rubric Configuration` 进行打分。

◦ **Few-Shot (少样本)**：植入 中的示例，教它识别什么是“模糊的需求”（如“优化体验”）。

- **规则加载**：

◦ 若 `Ticket.Type == "Bug"`，加载 Bug 评分卡（侧重复现步骤）。

◦ 若 `Ticket.Type == "Story"`，加载 Feature 评分卡（侧重 AC 和 User Story）。

- -------------------------------------------------------------------------------

**4. 关键逻辑实现 (Code Logic)**

**4.1 硬性门禁 (Hard Check Gate)**

这是系统中**绝对不可妥协**的代码逻辑，不依赖 LLM 的“感觉”。

```
def hard_check_gate(state: AgentState):
    report = state["score_report"]
    config = load_config(state["ticket"].project_key)

    # 规则 1: 存在任何 BLOCKER 级问题，直接拒绝
    if len(report.blocking_issues) > 0:
        return "reject"

    # 规则 2: 分数低于阈值 (如 60 分)，拒绝
    if report.total_score < config.threshold:
        return "reject"

    return "pass"

```

**4.2 评分配置化 (Rubric-as-Code)**

使用 YAML 管理评分规则，避免硬编码。

```
# rubric.yaml
FEATURE:
  threshold: 60
  weights:
    completeness: 0.4
    logic: 0.3
  # 必须存在的字段，缺失即 BLOCKER
  required_fields: ["acceptance_criteria", "user_story"]

BUG:
  threshold: 50
  required_fields: ["steps_to_reproduce", "environment"]

```

- -------------------------------------------------------------------------------

**5. 部署与运维方案 (Deployment)**

**5.1 推荐部署形态：局域网内部署 (LAN)**

基于 Source 的建议，考虑到 PRD 数据的敏感性，推荐以下部署：

- **容器化**：Core Service 打包为 Docker 镜像，运行在公司内部 K8s 或 VM 上。
- **网络策略**：只允许内网的 n8n 服务器访问 API 接口。
- **LLM 网关**：通过公司统一的 AI Proxy 访问外部模型（OpenAI/Gemini），进行审计和计费。

**5.2 数据持久化**

使用 **PostgreSQL** 存储以下核心表，用于后续的质量分析：

1. `workflow_runs`: 记录每次执行的 Input/Output 快照。

2. `audit_logs`: 记录 Gate 的决策结果（Pass/Reject）。

3. `eval_datasets`: 存储被标记为“误判”的样本，用于回归测试。

**5.3 监控与报警**

- **Trace**: 使用 LangSmith 或 OpenTelemetry 追踪 Agent 的思考过程。
- **Metrics**: 监控 `reject_rate`（打回率）和 `avg_latency`（平均耗时）。若 LLM 响应超时（>60s），触发报警。
- -------------------------------------------------------------------------------

**6. 实施路线图建议 (Implementation Path)**

1. **Week 1 (地基)**：定义 `TicketScoreReport` Schema，完成 `hard_check_gate` 代码逻辑，编写 `rubric.yaml`。

2. **Week 2 (核心)**：开发 Scoring Agent，跑通“输入 -> 评分 -> 拦截”的 MVP 闭环。

3. **Week 3 (集成)**：配置 n8n 流程，打通 Jira Webhook，实现自动化评论回写。

4. **Week 4 (增强)**：开发 Structuring Agent，处理非结构化文本；上线内网试点。

这份技术方案结合了系统 PRD 的需求，为你提供了从代码结构到部署运维的完整蓝图。